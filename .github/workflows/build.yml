name: Build VoiceInk
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Set up Xcode 16
        run: |
          sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer
          xcodebuild -version
      - name: Install dependencies
        run: |
          brew update
          brew install cmake
      - name: Build whisper.xcframework properly
        run: |
          # Create the exact directory structure Xcode expects
          mkdir -p VoiceInk-Dependencies/whisper.cpp
          
          # Clone whisper.cpp directly into the right spot
          git clone https://github.com/ggerganov/whisper.cpp.git VoiceInk-Dependencies/whisper.cpp/whisper.cpp
          
          # Navigate to the whisper.cpp directory and build
          cd VoiceInk-Dependencies/whisper.cpp/whisper.cpp
          
          # Make sure the build script is executable
          chmod +x build-xcframework.sh
          
          # Build the XCFramework (this creates it in build-apple/whisper.xcframework)
          echo "Building whisper.xcframework..."
          ./build-xcframework.sh
          
          # Create the target directory structure
          mkdir -p ../build-apple
          
          # Copy the built framework to where Xcode expects it
          cp -R build-apple/whisper.xcframework ../build-apple/
          
          # Verify it's in the right place
          echo "Verifying framework location..."
          ls -la ../build-apple/whisper.xcframework
      - name: Build VoiceInk
        run: |
          # Verify the framework exists before building
          if [ ! -d "VoiceInk-Dependencies/whisper.cpp/build-apple/whisper.xcframework" ]; then
            echo "‚ùå Framework not found at expected location!"
            echo "üîç Searching for framework:"
            find . -name "whisper.xcframework" -type d
            exit 1
          fi
          
          # Build with proper settings
          xcodebuild -project VoiceInk.xcodeproj \
                     -scheme VoiceInk \
                     -configuration Release \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGNING_REQUIRED=NO \
                     MACOSX_DEPLOYMENT_TARGET=14.5 \
                     -derivedDataPath build
          
          # Verify the build succeeded
          if [ -d "build/Build/Products/Release/VoiceInk.app" ]; then
            echo "‚úÖ Build succeeded!"
            ls -la build/Build/Products/Release/VoiceInk.app
          else
            echo "‚ùå Build failed"
            exit 1
          fi
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VoiceInk-macos14.5
          path: build/Build/Products/Release/VoiceInk.app