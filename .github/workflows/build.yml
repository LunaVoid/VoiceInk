name: Build VoiceInk

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      
      - name: Set up Xcode 16
        run: |
          sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer
          xcodebuild -version
      
      - name: Install dependencies
        run: |
          brew update
          brew install cmake
      
      - name: Fix Makefile path issue and build
        run: |
          echo "ðŸ”§ Running Makefile steps manually with correct paths..."
          
          # Run make whisper first to build the framework
          make whisper
          
          # The Makefile puts it in ~/VoiceInk-Dependencies, but Xcode expects ./VoiceInk-Dependencies
          # So we copy it to the right location
          echo "ðŸ“‚ Copying framework from home directory to project directory..."
          
          if [ -d "$HOME/VoiceInk-Dependencies" ]; then
            cp -R "$HOME/VoiceInk-Dependencies" "./VoiceInk-Dependencies"
            echo "âœ… Copied dependencies to project directory"
            ls -la ./VoiceInk-Dependencies/whisper.cpp/build-apple/whisper.xcframework
          else
            echo "âŒ Dependencies not found in home directory"
            echo "ðŸ” Looking for whisper frameworks..."
            find . -name "whisper.xcframework" -type d 2>/dev/null || echo "No whisper.xcframework found"
            find $HOME -name "whisper.xcframework" -type d 2>/dev/null || echo "No whisper.xcframework in home"
            exit 1
          fi
      
      - name: Build VoiceInk
        run: |
          echo "ðŸ”¨ Building VoiceInk..."
          
          # Verify framework is in the right place
          ls -la ./VoiceInk-Dependencies/whisper.cpp/build-apple/whisper.xcframework
          
          # Build the project
          make build
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VoiceInk-macos14.5
          path: |
            build/Release/VoiceInk.app
            Build/Products/Release/VoiceInk.app
            **/VoiceInk.app