name: Build VoiceInk

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      
      - name: Set up Xcode 16
        run: |
          sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer
          xcodebuild -version
      
      - name: Install dependencies
        run: |
          brew update
          brew install cmake
      
      - name: Build using official Makefile
        run: |
          echo "üîß Building VoiceInk using official Makefile..."
          
          # Run the official build process
          make all
          
          echo "‚úÖ Makefile build completed!"
      
      - name: Verify build artifacts
        run: |
          echo "üîç Verifying build artifacts..."
          
          # Find the built app
          find . -name "VoiceInk.app" -type d
          
          # Check if it's in the expected location
          if [ -d "build/Release/VoiceInk.app" ]; then
            echo "‚úÖ App found at: build/Release/VoiceInk.app"
            ls -la "build/Release/VoiceInk.app"
          elif [ -d "Build/Products/Release/VoiceInk.app" ]; then
            echo "‚úÖ App found at: Build/Products/Release/VoiceInk.app"
            ls -la "Build/Products/Release/VoiceInk.app"
          else
            echo "üîç Searching for VoiceInk.app..."
            find . -name "VoiceInk.app" -type d -exec ls -la {} \;
          fi
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VoiceInk-macos14.5
          path: |
            build/Release/VoiceInk.app
            Build/Products/Release/VoiceInk.app
            **/VoiceInk.app