name: Build VoiceInk

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      
      - name: Set up Xcode 16
        run: |
          sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer
          xcodebuild -version
      
      - name: Create framework from scratch - bulletproof approach
        run: |
          echo "üîß Creating framework structure exactly as Xcode expects..."
          
          # Create the EXACT directory structure
          mkdir -p VoiceInk-Dependencies/whisper.cpp/build-apple
          
          # Download a pre-built working whisper.xcframework 
          # Using the latest release from whisper.cpp
          cd VoiceInk-Dependencies/whisper.cpp/build-apple
          
          # Get latest whisper.cpp release with XCFramework
          curl -L -o whisper.xcframework.zip "https://github.com/ggerganov/whisper.cpp/releases/download/v1.5.4/whisper-v1.5.4-xcframework.zip"
          
          # Extract it
          unzip whisper.xcframework.zip
          
          # Verify it exists
          echo "‚úÖ Framework created:"
          ls -la whisper.xcframework/
          
          # Go back to project root
          cd ../../../
          
          # Final verification - this MUST show the framework
          echo "üîç Final verification - framework at expected location:"
          ls -la VoiceInk-Dependencies/whisper.cpp/build-apple/whisper.xcframework
      
      - name: Build VoiceInk with minimal settings
        run: |
          echo "üî® Building VoiceInk with minimal complexity..."
          
          # Simple, direct build
          xcodebuild -project VoiceInk.xcodeproj \
                     -scheme VoiceInk \
                     -configuration Release \
                     -derivedDataPath build \
                     CODE_SIGNING_REQUIRED=NO
          
          echo "‚úÖ Build completed!"
          
          # Find the app
          find build -name "VoiceInk.app" -type d
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VoiceInk-macos14.5
          path: build/Build/Products/Release/VoiceInk.app