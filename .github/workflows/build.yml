name: Build VoiceInk

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15  # Has Xcode 16
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      
      - name: Set up Xcode 16
        run: |
          sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer
          xcodebuild -version
      
      - name: Install dependencies
        run: |
          brew update
          brew install cmake
      
      - name: Create exact directory structure
        run: |
          # Create the EXACT directory structure that Xcode expects
          mkdir -p VoiceInk-Dependencies/whisper.cpp
          # Clone whisper.cpp directly into the expected location
          git clone https://github.com/ggerganov/whisper.cpp.git VoiceInk-Dependencies/whisper.cpp/whisper.cpp
          cd VoiceInk-Dependencies/whisper.cpp/whisper.cpp
          # Build the XCFramework
          ./build-xcframework.sh
          # Move the built framework to the CORRECT location Xcode expects
          mkdir -p ../build-apple
          cp -R build-apple/whisper.xcframework ../build-apple/
          # Verify the framework exists in the correct location
          ls -la ../build-apple/whisper.xcframework
      
      - name: Deep framework validation
        run: |
          echo "ðŸ” Deep validation of XCFramework..."
          FRAMEWORK_PATH="VoiceInk-Dependencies/whisper.cpp/build-apple/whisper.xcframework"
          
          echo "ðŸ“‚ Framework exists check:"
          ls -la "$FRAMEWORK_PATH"
          
          echo "ðŸ“„ Info.plist contents:"
          cat "$FRAMEWORK_PATH/Info.plist"
          
          echo "ðŸ” Framework permissions:"
          ls -la "$FRAMEWORK_PATH"/*
          
          echo "ðŸ” Checking for symlinks:"
          find "$FRAMEWORK_PATH" -type l
          
          echo "ðŸ” Framework binary validation:"
          find "$FRAMEWORK_PATH" -name "*.framework" -exec ls -la {} \;
          
          echo "ðŸ” Absolute path check:"
          realpath "$FRAMEWORK_PATH"
          
          echo "ðŸ” Full directory tree:"
          tree "$FRAMEWORK_PATH" || find "$FRAMEWORK_PATH" -type f
      
      - name: Try alternative XCFramework approach
        run: |
          echo "ðŸ”§ Trying to rebuild XCFramework with different approach..."
          
          cd VoiceInk-Dependencies/whisper.cpp/whisper.cpp
          
          # Clean previous build
          rm -rf build-apple
          
          # Build again but keep it in place this time
          ./build-xcframework.sh
          
          # Copy to parent with verbose output
          echo "ðŸ“‚ Copying framework with verbose output:"
          cp -Rv build-apple/whisper.xcframework ../build-apple/
          
          # Set proper permissions
          echo "ðŸ”§ Setting proper permissions:"
          chmod -R 755 ../build-apple/whisper.xcframework
          
          # Final verification
          echo "âœ… Final framework check:"
          ls -la ../build-apple/whisper.xcframework
          find ../build-apple/whisper.xcframework -name "*.framework" -exec file {} \;
      
      - name: Build VoiceInk with maximum debugging
        run: |
          echo "ðŸ”¨ Building VoiceInk with maximum debugging..."
          
          # Show current directory and framework location
          pwd
          echo "Framework should be at:"
          ls -la VoiceInk-Dependencies/whisper.cpp/build-apple/whisper.xcframework || echo "NOT FOUND"
          
          # Try building with different derived data location to avoid caching issues
          rm -rf build
          
          # Build with maximum verbosity and debugging
          set -x
          xcodebuild -project VoiceInk.xcodeproj -scheme VoiceInk -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE="" \
            MACOSX_DEPLOYMENT_TARGET=14.5 \
            -allowProvisioningUpdates \
            -derivedDataPath build \
            -destination 'platform=macOS' \
            -verbose || echo "Build failed, continuing to investigate..."
          set +x
          
          # Check if app was created despite errors
          BUILD_APP="build/Build/Products/Release/VoiceInk.app"
          if [ -d "$BUILD_APP" ]; then
            echo "âœ… Build succeeded! App found at: $BUILD_APP"
            ls -la "$BUILD_APP"
          else
            echo "âŒ Build failed - investigating..."
            echo "ðŸ“ Contents of build directory:"
            find build -name "*.app" -type d 2>/dev/null || echo "No .app found"
            
            echo "ðŸ“„ Checking build logs for framework issues:"
            find build -name "*.log" -exec grep -l "whisper" {} \; | head -3 | xargs cat
          fi
      
      - name: Upload artifact (if exists)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: VoiceInk-macos14.5
          path: build/Build/Products/Release/VoiceInk.app