name: Build VoiceInk
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Set up Xcode 16
        run: |
          sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer
          xcodebuild -version
      - name: Install dependencies
        run: |
          brew update
          brew install cmake
      - name: Build whisper.xcframework correctly
        run: |
          echo "üîß Building whisper.xcframework..."
          # Create the directory structure at the ROOT level (not inside VoiceInk/)
          mkdir -p VoiceInk-Dependencies/whisper.cpp
          # Clone whisper.cpp
          git clone https://github.com/ggerganov/whisper.cpp.git VoiceInk-Dependencies/whisper.cpp/whisper.cpp
          cd VoiceInk-Dependencies/whisper.cpp/whisper.cpp
          # Make build script executable
          chmod +x build-xcframework.sh
          # Build the framework
          ./build-xcframework.sh
          # Copy to CORRECT location where Xcode expects it
          mkdir -p ../../build-apple
          cp -R build-apple/whisper.xcframework ../../build-apple/
          echo "‚úÖ Framework built and copied to correct location"
          ls -la ../../build-apple/whisper.xcframework
      - name: Verify framework location - CRITICAL STEP
        run: |
          echo "üîç Verifying framework is in the EXACT location Xcode expects..."
          EXPECTED_PATH="VoiceInk-Dependencies/whisper.cpp/build-apple/whisper.xcframework"
          if [ -d "$EXPECTED_PATH" ]; then
            echo "‚úÖ SUCCESS! Framework found at: $EXPECTED_PATH"
            echo "Framework contents:"
            ls -la "$EXPECTED_PATH"
          else
            echo "‚ùå CRITICAL ERROR: Framework not found at expected path: $EXPECTED_PATH"
            echo "üîç Current directory structure:"
            pwd
            echo "üìÅ Contents of VoiceInk-Dependencies:"
            ls -la VoiceInk-Dependencies/ || echo "No VoiceInk-Dependencies directory"
            echo "üìÅ Contents of VoiceInk-Dependencies/whisper.cpp:"
            ls -la VoiceInk-Dependencies/whisper.cpp/ || echo "No whisper.cpp directory"
            echo "üìÅ Contents of VoiceInk-Dependencies/whisper.cpp/build-apple:"
            ls -la VoiceInk-Dependencies/whisper.cpp/build-apple/ || echo "No build-apple directory"
            exit 1
          fi
      - name: Build VoiceInk
        run: |
          echo "üî® Building VoiceInk with correct framework location..."
          xcodebuild -project VoiceInk.xcodeproj \
                     -scheme VoiceInk \
                     -configuration Release \
                     -derivedDataPath build \
                     CODE_SIGNING_REQUIRED=NO \
                     CODE_SIGN_IDENTITY="" \
                     MACOSX_DEPLOYMENT_TARGET=14.5
          # Verify build succeeded
          if [ -d "build/Build/Products/Release/VoiceInk.app" ]; then
            echo "üéâ SUCCESS! VoiceInk built successfully!"
            ls -la build/Build/Products/Release/VoiceInk.app
          else
            echo "‚ùå Build failed - checking for any error logs..."
            echo "üìÑ Last 20 lines of build log:"
            tail -20 build/Logs/Build/*.log || echo "No build logs found"
            exit 1
          fi
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VoiceInk-macos14.5
          path: build/Build/Products/Release/VoiceInk.app