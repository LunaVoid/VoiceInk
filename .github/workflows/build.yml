name: Build VoiceInk
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Set up Xcode 16
        run: |
          sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer
          xcodebuild -version
      - name: Install dependencies
        run: |
          brew update
          brew install cmake
      - name: Build whisper.xcframework in EXACT location Xcode expects
        run: |
          echo "üîß Creating EXACT directory structure Xcode expects..."
          # Create the precise directory structure at the root level
          mkdir -p /Users/runner/work/VoiceInk/VoiceInk-Dependencies/whisper.cpp/build-apple
          
          echo "üì¶ Cloning whisper.cpp..."
          git clone https://github.com/ggerganov/whisper.cpp.git /tmp/whisper-build
          
          echo "üî® Building XCFramework..."
          cd /tmp/whisper-build
          chmod +x build-xcframework.sh
          ./build-xcframework.sh
          
          echo "‚úÖ Copying framework to EXACT location Xcode needs..."
          cp -R build-apple/whisper.xcframework /Users/runner/work/VoiceInk/VoiceInk-Dependencies/whisper.cpp/build-apple/
          
          echo "üîç Verifying framework location..."
          ls -la /Users/runner/work/VoiceInk/VoiceInk-Dependencies/whisper.cpp/build-apple/whisper.xcframework
      - name: Build VoiceInk
        run: |
          echo "üöÄ Building VoiceInk with framework in correct location..."
          xcodebuild -project VoiceInk.xcodeproj \
                     -scheme VoiceInk \
                     -configuration Release \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGNING_REQUIRED=NO \
                     MACOSX_DEPLOYMENT_TARGET=14.5 \
                     -derivedDataPath build
          # Verify build succeeded
          if [ -d "build/Build/Products/Release/VoiceInk.app" ]; then
            echo "üéâ SUCCESS! Build completed successfully!"
            ls -la build/Build/Products/Release/VoiceInk.app
          else
            echo "‚ùå Build failed"
            exit 1
          fi
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VoiceInk-macos14.5
          path: build/Build/Products/Release/VoiceInk.app