name: Build VoiceInk

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15  # Has Xcode 16
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    
    - name: Set up Xcode 16
      run: |
        sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer
        xcodebuild -version
    
    - name: Install dependencies
      run: |
        brew update
        brew install cmake
    
    - name: Build whisper.xcframework manually
      run: |
        # Create the exact directory structure the Xcode project expects
        mkdir -p VoiceInk-Dependencies/whisper.cpp/build-apple
        
        # Clone and build whisper.cpp directly in the right location
        git clone https://github.com/ggerganov/whisper.cpp.git VoiceInk-Dependencies/whisper.cpp/whisper.cpp
        cd VoiceInk-Dependencies/whisper.cpp/whisper.cpp
        ./build-xcframework.sh
        
        # Verify the framework exists where Xcode expects it
        ls -la build-apple/whisper.xcframework
        cp -R build-apple/whisper.xcframework ../../build-apple/
    
    - name: Build VoiceInk
      run: |
        # Use xcodebuild directly with the correct paths
        xcodebuild -project VoiceInk.xcodeproj -scheme VoiceInk -configuration Release \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          MACOSX_DEPLOYMENT_TARGET=14.5 \
          -allowProvisioningUpdates \
          -derivedDataPath build
        
        # Verify build succeeded
        if [ -d "build/Build/Products/Release/VoiceInk.app" ]; then
          echo "✅ Build succeeded!"
          ls -la build/Build/Products/Release/VoiceInk.app
        else
          echo "❌ Build failed"
          exit 1
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: VoiceInk-macos14.5
        path: build/Build/Products/Release/VoiceInk.app