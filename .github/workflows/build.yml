name: Build VoiceInk
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Set up Xcode 16
        run: |
          sudo xcode-select -s /Applications/Xcode_16.0.app/Contents/Developer
          xcodebuild -version
      - name: Install dependencies
        run: |
          brew update
          brew install cmake
      - name: Build whisper framework correctly
        run: |
          # Create the exact directory structure Xcode expects
          mkdir -p VoiceInk-Dependencies/whisper.cpp
          # Clone whisper.cpp directly into the expected location
          git clone https://github.com/ggerganov/whisper.cpp.git VoiceInk-Dependencies/whisper.cpp/whisper.cpp
          cd VoiceInk-Dependencies/whisper.cpp/whisper.cpp
          # Build the XCFramework
          ./build-xcframework.sh
          # Move to the exact location Xcode needs
          mkdir -p ../build-apple
          mv build-apple/whisper.xcframework ../build-apple/
      - name: Build VoiceInk
        run: |
          xcodebuild -project VoiceInk.xcodeproj -scheme VoiceInk -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            MACOSX_DEPLOYMENT_TARGET=14.5 \
            -derivedDataPath build
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VoiceInk-macos14.5
          path: build/Build/Products/Release/VoiceInk.app